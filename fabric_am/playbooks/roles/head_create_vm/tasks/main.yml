---
# /tasks/main.yml
#

- name: Create a VM
  os_server:
    state: present
    auth:
      auth_url: "{{ auth_url }}"
      password: "{{ password }}"
      project_name: "{{ project_name }}"
      username: "{{ username }}"
    name: "{{ vmname }}"
    image: "{{ image }}"
    key_name: "{{ key }}"
    timeout: 200
    flavor: "{{ flavor }}"
    availability_zone: "{{ workernode }}"
    nics:
      - net-name: "{{ network_name }}"
    security_groups: "{{ security_group }}"

  register: instance_reply

- set_fact:
      workernode_name: "{{ instance_reply.stdout.replace('|', ' ').split()[1] }}"
      kvmguest_name: "{{ instance_reply.stdout.replace('|', ' ').split()[2] }}"
      kvmguest_status: "{{ instance_reply.stdout.replace('|', ' ').split()[3] }}"

